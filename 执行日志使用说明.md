# 执行日志记录系统使用说明

## 功能概述

本系统实现了完整的程序执行日志记录功能，满足以下需求：

### 记录内容
1. **时间**：格式为 `年-月-日 时:分`
2. **当时执行任务**：详细的任务描述和执行步骤

### 记录位置
1. **打开程序**：记录程序启动时间和业务类型
2. **选择执行任务**：记录任务开始执行
3. **执行详细过程**：记录每个执行步骤
4. **单次执行总时长**：自动计算并记录任务执行时间

### 保存位置
- **基础目录**：当前程序目录下的 `execlog` 文件夹
- **业务分类**：按业务名称创建子文件夹
- **文件命名**：以当天日期命名（如：`2025-09-19.log`）

## 目录结构示例

```
execlog/
├── 信控停机预警/
│   └── 2025-09-19.log
├── 低质专线预警/
│   └── 2025-09-19.log
├── 代付欠费超逾期缴费预警/
│   └── 2025-09-19.log
├── 插件系统主程序/
│   └── 2025-09-19.log
└── 其他业务/
    └── 2025-09-19.log
```

## 使用方法

### 1. 基础使用

```python
from exec_logger import exec_logger, log_step, log_success, log_error

# 启动程序日志
business_name = "信控停机预警"
exec_logger.start_program(business_name)

# 使用任务上下文管理器（推荐）
with exec_logger.task_context("处理预警消息", business_name):
    log_step("开始获取预警数据")
    # 你的业务逻辑
    log_step("处理预警数据")
    # 更多业务逻辑
    log_success("预警消息处理完成")
```

### 2. 装饰器使用

```python
from exec_logger import log_execution

@log_execution(business_name="信控停机预警", task_name="发送预警消息")
def send_warning_message():
    log_step("准备发送消息")
    # 你的业务逻辑
    log_success("消息发送成功")
    return "发送完成"
```

### 3. 错误处理

```python
try:
    # 可能出错的代码
    risky_operation()
except Exception as e:
    log_error(e, "操作失败的上下文描述", business_name)
```

### 4. 便捷函数

```python
from exec_logger import start_program_log, log_step, log_success, log_error

# 启动程序日志
start_program_log("业务名称")

# 记录步骤
log_step("执行某个步骤")

# 记录成功
log_success("操作成功完成")

# 记录错误
log_error(exception, "错误上下文")
```

## 日志格式示例

```
[2025-09-19 09:42] 程序启动 - 业务类型: 信控停机预警
==================================================
[2025-09-19 09:42] 开始执行任务: 处理预警消息
[2025-09-19 09:42] 执行步骤: 开始获取预警数据
[2025-09-19 09:42] 执行步骤: 处理预警数据
[2025-09-19 09:42] 执行成功: 预警消息处理完成
[2025-09-19 09:42] 任务结束 - 总执行时长: 1.25秒
------------------------------
```

## 错误日志格式示例

```
[2025-09-19 09:42] 执行异常 - 数据库连接失败
错误类型: ConnectionError
错误信息: 无法连接到数据库服务器
错误堆栈:
Traceback (most recent call last):
  File "example.py", line 10, in connect_database
    connection = database.connect()
ConnectionError: 无法连接到数据库服务器
```

## 已集成的程序

### 1. 4a-warning-sync.py
- 自动记录程序启动和业务选择
- 记录消息处理的详细步骤
- 记录成功/失败状态和执行时长

### 2. main.py
- 记录插件系统启动过程
- 记录插件初始化状态
- 记录主循环运行状态

## 注意事项

1. **自动创建目录**：系统会自动创建 `execlog` 目录和业务子目录
2. **日期文件**：每天的日志会保存在以当天日期命名的文件中
3. **追加写入**：同一天的多次运行会追加到同一个日志文件中
4. **编码格式**：日志文件使用 UTF-8 编码，支持中文
5. **时间精度**：执行时长精确到小数点后两位秒

## 测试

运行测试脚本验证功能：

```bash
python test_exec_logger.py
```

测试完成后，检查 `execlog` 目录下生成的日志文件。

## 扩展使用

如果需要在其他 Python 文件中使用日志记录功能，只需：

1. 导入模块：`from exec_logger import exec_logger, log_step, log_success, log_error`
2. 启动程序日志：`exec_logger.start_program("你的业务名称")`
3. 在关键位置添加日志记录调用

这样就能实现完整的执行过程追踪和记录。